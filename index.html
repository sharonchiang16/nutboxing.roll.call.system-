<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台大拳擊社點名系統</title>
    
    <!-- 樣式庫 (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: sans-serif; background-color: #f3f4f6; }
        .error-box { background: #fee2e2; color: #991b1b; padding: 20px; border: 2px solid #ef4444; margin: 20px; border-radius: 8px; }
    </style>

    <!-- 1. 錯誤監控：如果有任何錯誤，直接顯示在畫面上 -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            var root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div class="error-box">
                        <h2 class="text-xl font-bold mb-2">⚠️ 程式發生錯誤</h2>
                        <p><strong>錯誤訊息:</strong> ${msg}</p>
                        <p><strong>行數:</strong> ${line}</p>
                        <p class="text-sm mt-2 text-gray-600">請截圖此畫面給開發者。</p>
                    </div>
                `;
            }
            return false;
        };
    </script>

    <!-- 2. 載入 React (使用 unpkg 來源，有時候比 cdnjs 穩) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

    <!-- 程式入口：預設顯示載入中 -->
    <div id="root" class="min-h-screen flex flex-col items-center justify-center text-gray-500">
        <div class="animate-pulse flex flex-col items-center">
            <div class="h-8 w-8 bg-gray-300 rounded-full mb-4"></div>
            <p>系統啟動中 (Debug Mode)...</p>
            <p class="text-xs mt-2">如果卡住超過 5 秒，代表程式出錯了</p>
        </div>
    </div>

    <!-- 主程式邏輯 -->
    <script type="text/babel">
        try {
            const { useState } = React;

            // --- Google Sheet 後端設定 ---
            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzBMcX9Hk85QA_pZEAu5y46rxORHBNTN7uPkjYBVEY/exec";

            // --- App 主元件 ---
            function App() {
                const [status, setStatus] = useState('idle'); // idle, loading, success, error
                const [formType, setFormType] = useState('member'); // member, trial
                const [formData, setFormData] = useState({ studentId: '', name: '', phone: '' });

                // 提交資料到 Google Sheet
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setStatus('loading');

                    const payload = {
                        type: formType === 'member' ? '社員簽到' : '體驗登記',
                        timestamp: new Date().toLocaleString('zh-TW'),
                        ...formData
                    };

                    try {
                        // 使用 no-cors 模式 (跨網域標準做法)
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: "POST",
                            mode: "no-cors",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        });
                        
                        // 因為 no-cors 不會回傳內容，我們假設請求發出就是成功
                        setStatus('success');
                        setFormData({ studentId: '', name: '', phone: '' }); // 清空表單
                    } catch (err) {
                        console.error(err);
                        alert("連線失敗，請檢查網路");
                        setStatus('idle');
                    }
                };

                // 成功畫面
                if (status === 'success') {
                    return (
                        <div className="min-h-screen flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-xl shadow-lg text-center max-w-sm w-full">
                                <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span className="text-2xl">✓</span>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">登記成功！</h2>
                                <p className="text-gray-500 mb-6">資料已傳送到後台。</p>
                                <button 
                                    onClick={() => setStatus('idle')}
                                    className="w-full bg-gray-200 py-3 rounded-lg font-bold hover:bg-gray-300"
                                >
                                    返回首頁
                                </button>
                            </div>
                        </div>
                    );
                }

                // 主畫面 (簡化版 UI，先確保功能正常)
                return (
                    <div className="min-h-screen bg-white p-6 max-w-md mx-auto shadow-xl">
                        <header className="mb-8 text-center border-b pb-4">
                            <h1 className="text-2xl font-bold text-red-800">台大拳擊社</h1>
                            <p className="text-sm text-gray-500">點名系統 v5 (測試版)</p>
                        </header>

                        <div className="flex gap-2 mb-6 bg-gray-100 p-1 rounded-lg">
                            <button 
                                onClick={() => setFormType('member')}
                                className={`flex-1 py-2 rounded-md font-bold transition-all ${formType === 'member' ? 'bg-white shadow text-red-800' : 'text-gray-500'}`}
                            >
                                社員簽到
                            </button>
                            <button 
                                onClick={() => setFormType('trial')}
                                className={`flex-1 py-2 rounded-md font-bold transition-all ${formType === 'trial' ? 'bg-white shadow text-gray-800' : 'text-gray-500'}`}
                            >
                                體驗登記
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                            {formType === 'member' ? (
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">學號</label>
                                    <input 
                                        type="text" required placeholder="B12345678"
                                        className="w-full p-3 border rounded-lg uppercase"
                                        value={formData.studentId}
                                        onChange={e => setFormData({...formData, studentId: e.target.value.toUpperCase()})}
                                    />
                                </div>
                            ) : (
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">手機號碼</label>
                                    <input 
                                        type="tel" required placeholder="09xxxxxxxx"
                                        className="w-full p-3 border rounded-lg"
                                        value={formData.phone}
                                        onChange={e => setFormData({...formData, phone: e.target.value})}
                                    />
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">姓名</label>
                                <input 
                                    type="text" required placeholder="請輸入姓名"
                                    className="w-full p-3 border rounded-lg"
                                    value={formData.name}
                                    onChange={e => setFormData({...formData, name: e.target.value})}
                                />
                            </div>

                            <button 
                                type="submit" 
                                disabled={status === 'loading'}
                                className={`mt-4 w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all ${formType === 'member' ? 'bg-red-800 hover:bg-red-900' : 'bg-gray-800 hover:bg-gray-900'} disabled:opacity-50`}
                            >
                                {status === 'loading' ? '處理中...' : '送出'}
                            </button>
                        </form>
                        
                        <div className="mt-8 text-center text-xs text-gray-400">
                            後台連結測試中...
                        </div>
                    </div>
                );
            }

            // 啟動 React
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
            
        } catch (err) {
            // 如果 React 啟動失敗，這裡會抓到錯誤
            document.getElementById('root').innerHTML = `
                <div class="error-box">
                    <h2 class="text-xl font-bold">⚠️ 初始化失敗</h2>
                    <p>${err.message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
