<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台大拳擊社點名系統 (檢測模式)</title>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; line-height: 1.6; background: #f3f4f6; }
        .status-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
        .step { margin-bottom: 10px; display: flex; align-items: center; }
        .step.pending { color: #666; }
        .step.success { color: #166534; font-weight: bold; }
        .step.error { color: #991b1b; font-weight: bold; }
        .icon { width: 20px; display: inline-block; margin-right: 10px; }
        #root { display: none; } /* 預設隱藏，等載入成功再顯示 */
        
        /* App 樣式 */
        .app-container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
    </style>

    <!-- 步驟 1: 載入 Tailwind (樣式庫) -->
    <script src="https://cdn.tailwindcss.com" onload="markSuccess('step1')" onerror="markError('step1')"></script>
    
    <!-- 步驟 2: 載入 React (核心引擎) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" onload="markSuccess('step2')" onerror="markError('step2')"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" onload="markSuccess('step3')" onerror="markError('step3')"></script>
    
    <!-- 步驟 3: 載入 Babel (翻譯機) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" onload="markSuccess('step4')" onerror="markError('step4')"></script>

    <script>
        function markSuccess(id) {
            const el = document.getElementById(id);
            if(el) { el.className = 'step success'; el.innerHTML = '<span class="icon">✅</span>' + el.innerText.replace('...', ' 完成'); }
            checkAllLoaded();
        }
        function markError(id) {
            const el = document.getElementById(id);
            if(el) { el.className = 'step error'; el.innerHTML = '<span class="icon">❌</span>' + el.innerText.replace('...', ' 失敗 (網路封鎖)'); }
            document.getElementById('error-guide').style.display = 'block';
        }
        function checkAllLoaded() {
            // 只有當所有外部工具都載入成功，才啟動 App
            if(window.React && window.ReactDOM && window.Babel && window.tailwind) {
                document.getElementById('status-panel').style.display = 'none'; // 隱藏檢查表
                document.getElementById('root').style.display = 'block'; // 顯示 App
            }
        }
    </script>
</head>
<body>

    <!-- 檢測面板：如果 App 沒跑出來，使用者會看到這個面板 -->
    <div id="status-panel" class="status-box">
        <h2 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">系統啟動檢測中...</h2>
        <div id="step1" class="step pending"><span class="icon">⏳</span>載入外觀引擎 (Tailwind)...</div>
        <div id="step2" class="step pending"><span class="icon">⏳</span>載入 React 核心...</div>
        <div id="step3" class="step pending"><span class="icon">⏳</span>載入 React DOM...</div>
        <div id="step4" class="step pending"><span class="icon">⏳</span>載入程式翻譯機 (Babel)...</div>
        
        <div id="error-guide" style="display:none; margin-top:20px; padding-top:10px; border-top:1px dashed #ccc; font-size:14px; color:#d97706;">
            <strong>⚠️ 發生問題：</strong><br>
            您的網路環境似乎擋住了外部程式庫的下載。<br>
            請嘗試：<br>
            1. 切換到手機熱點 (4G/5G) 試試看。<br>
            2. 如果是用學校 Wi-Fi，可能會擋 CDN。
        </div>
    </div>

    <div id="root" class="bg-gray-100 min-h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons ---
        const User = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Check = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const CreditCard = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>;
        const ArrowLeft = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const Copy = ({size=16, className}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const CalendarIcon = ({size=18, className}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const AlertCircle = ({size=18, className}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const Users = ({size=32}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const GraduationCap = ({size=32}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>;

        function App() {
            const [page, setPage] = useState('home');
            const [loading, setLoading] = useState(false);
            const [identityType, setIdentityType] = useState('ntu'); 
            
            const [memberData, setMemberData] = useState({ studentId: '', phone: '', name: '', date: new Date().toISOString().split('T')[0] });
            const [purchaseData, setPurchaseData] = useState({ name: '', studentId: '', department: '', phone: '', last5: '' });
            const [trialData, setTrialData] = useState({ name: '', phone: '', last5: '', date: new Date().toISOString().split('T')[0] });

            const classDates = [
                "2026-03-04", "2026-03-11", "2026-03-18", "2026-03-25", "2026-04-01", 
                "2026-04-22", "2026-04-29", "2026-05-06", "2026-05-13", "2026-05-20", "2026-05-27"
            ];

            // 您的 Apps Script 網址
            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrny07-26bJBAVFcJ3_PVRm-y0Rc3KzfoMl0pguIzhm0W9DgxCcgXzqgSXbogz62Tr/exec"; 

            const submitToGoogleSheet = async (data, type) => {
                setLoading(true);
                let finalType = type;
                if (type === 'Member' || type === 'Purchase') finalType = `${type}_${identityType === 'ntu' ? 'NTU' : 'External'}`;

                const payload = { type: finalType, timestamp: new Date().toLocaleString('zh-TW'), ...data };

                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    setLoading(false);
                    setPage('success');
                } catch (error) {
                    console.error(error);
                    alert("連線發生錯誤，請檢查網路。");
                    setLoading(false);
                }
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text);
                alert(`已複製: ${text}`);
            };

            // Components
            const Header = () => (
                <div className="bg-red-800 text-white p-4 shadow-md flex items-center justify-center sticky top-0 z-10 safe-top">
                    <h1 className="text-xl font-bold tracking-wider">NTU BOXING 點名系統</h1>
                </div>
            );

            const BackButton = ({ to }) => (
                <button onClick={() => setPage(to)} className="flex items-center text-gray-500 mb-6 hover:text-red-800 transition-colors">
                    <ArrowLeft size={20} /> <span className="ml-1">返回</span>
                </button>
            );

            const IdentityCard = ({ icon: Icon, title, subtitle, onClick, colorClass = "border-red-800 text-red-800" }) => (
                <button onClick={onClick} className={`w-full group relative overflow-hidden bg-white border-2 ${colorClass} rounded-2xl p-6 shadow-md active:scale-95 transition-all hover:bg-gray-50 flex flex-col items-center gap-2`}>
                    <Icon size={32} />
                    <span className="text-xl font-bold">{title}</span>
                    <span className="text-xs opacity-75">{subtitle}</span>
                </button>
            );

            // --- Pages ---
            const HomePage = () => (
                <div className="flex flex-col gap-4 p-6 animate-fade-in pb-12">
                    <div className="text-center mb-2">
                        <p className="text-gray-600 text-lg">歡迎來到台大拳擊社</p>
                        <p className="text-sm text-gray-500">請選擇您的服務</p>
                    </div>
                    <button onClick={() => setPage('member_select')} className="group bg-white border-2 border-red-800 text-red-800 rounded-2xl p-6 shadow-lg active:scale-95 transition-all hover:bg-red-50">
                        <div className="flex items-center justify-between">
                            <div className="flex flex-col items-start"><span className="text-2xl font-bold">我是社員</span><span className="text-sm opacity-75">Member Check-in</span></div>
                            <User size={40} />
                        </div>
                    </button>
                    <button onClick={() => setPage('purchase_select')} className="group bg-slate-100 border-2 border-slate-600 text-slate-800 rounded-2xl p-6 shadow-lg active:scale-95 transition-all hover:bg-slate-200">
                        <div className="flex items-center justify-between">
                            <div className="flex flex-col items-start"><span className="text-2xl font-bold">購買課程</span><span className="text-sm opacity-75">Purchase Course</span></div>
                            <CreditCard size={40} />
                        </div>
                    </button>
                    <button onClick={() => setPage('trial')} className="group bg-slate-800 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-all hover:bg-slate-700">
                        <div className="flex items-center justify-between">
                            <div className="flex flex-col items-start"><span className="text-2xl font-bold">我要體驗</span><span className="text-sm opacity-75">Single Trial Class</span></div>
                            <Check size={40} />
                        </div>
                    </button>
                    <div className="mt-4 text-center"><p className="text-xs text-gray-400">© 2026 NTU Boxing Club</p></div>
                </div>
            );

            const IdentitySelectPage = ({ title, nextStep }) => (
                <div className="p-6 animate-slide-in">
                    <BackButton to="home" />
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">{title}</h2>
                    <p className="text-gray-500 mb-6">請選擇您的身份類別</p>
                    <div className="flex flex-col gap-4">
                        <IdentityCard icon={GraduationCap} title="台大教職員工生" subtitle="NTU Students / Faculty" onClick={() => { setIdentityType('ntu'); setPage(nextStep); }} />
                        <IdentityCard icon={Users} title="校外人士" subtitle="External Members" colorClass="border-slate-600 text-slate-800" onClick={() => { setIdentityType('external'); setPage(nextStep); }} />
                    </div>
                </div>
            );

            const MemberFormPage = () => (
                <div className="p-6 animate-slide-in">
                    <BackButton to="member_select" />
                    <h2 className="text-2xl font-bold text-red-900 mb-2 border-l-4 border-red-800 pl-3">{identityType === 'ntu' ? '台大社員簽到' : '校外社員簽到'}</h2>
                    <p className="text-sm text-gray-500 mb-6 pl-4">Member Check-in</p>
                    <form onSubmit={(e) => { e.preventDefault(); submitToGoogleSheet(memberData, 'Member'); }} className="flex flex-col gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">上課日期</label>
                            <div className="relative">
                                <select required className="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg appearance-none focus:ring-2 focus:ring-red-500 outline-none" value={memberData.date} onChange={(e) => setMemberData({...memberData, date: e.target.value})}>
                                    {classDates.map(date => <option key={date} value={date}>{date}</option>)}
                                </select>
                                <CalendarIcon className="absolute right-3 top-3.5 text-gray-400" />
                            </div>
                        </div>
                        {identityType === 'ntu' ? (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">學號 (Student ID)</label>
                                <input type="text" required placeholder="例如: B12345678" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none uppercase font-mono tracking-wider" value={memberData.studentId} onChange={(e) => setMemberData({...memberData, studentId: e.target.value.toUpperCase()})} />
                            </div>
                        ) : (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">手機號碼</label>
                                <input type="tel" required placeholder="09xxxxxxxx" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-600 outline-none font-mono" value={memberData.phone} onChange={(e) => setMemberData({...memberData, phone: e.target.value})} />
                            </div>
                        )}
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">姓名</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" value={memberData.name} onChange={(e) => setMemberData({...memberData, name: e.target.value})} /></div>
                        <button type="submit" disabled={loading} className={`mt-4 w-full text-white py-4 rounded-xl font-bold text-lg shadow-md active:scale-95 transition-all disabled:opacity-50 flex justify-center items-center ${identityType === 'ntu' ? 'bg-red-800 hover:bg-red-900' : 'bg-slate-800 hover:bg-slate-900'}`}>{loading ? "處理中..." : "確認簽到"}</button>
                    </form>
                </div>
            );

            const PurchaseFormPage = () => {
                const price = identityType === 'ntu' ? 1200 : 1800;
                return (
                    <div className="p-6 animate-slide-in">
                        <BackButton to="purchase_select" />
                        <h2 className="text-2xl font-bold text-slate-800 mb-2 border-l-4 border-slate-800 pl-3">{identityType === 'ntu' ? '台大教職員工生繳費' : '校外人士繳費'}</h2>
                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                            <h3 className="font-bold text-orange-800 flex items-center mb-2"><AlertCircle className="mr-2" /> 匯款資訊</h3>
                            <p className="text-sm text-orange-900 mb-2">本學期社費：<span className="font-bold text-lg text-red-600">${price}</span></p>
                            <div className="bg-white p-3 rounded border border-orange-100 flex justify-between items-center cursor-pointer active:bg-gray-50" onClick={() => copyToClipboard('88660930767982')}>
                                <div><span className="text-xs text-gray-500 block">將來銀行 (823)</span><span className="font-mono font-bold text-lg">88660930767982</span></div>
                                <Copy className="text-gray-400" />
                            </div>
                        </div>
                        <form onSubmit={(e) => { e.preventDefault(); submitToGoogleSheet(purchaseData, 'Purchase'); }} className="flex flex-col gap-4">
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">姓名</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.name} onChange={(e) => setPurchaseData({...purchaseData, name: e.target.value})} /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">手機</label><input type="tel" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.phone} onChange={(e) => setPurchaseData({...purchaseData, phone: e.target.value})} /></div>
                            </div>
                            {identityType === 'ntu' && (
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">學號</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none uppercase font-mono focus:ring-2 focus:ring-slate-500" value={purchaseData.studentId} onChange={(e) => setPurchaseData({...purchaseData, studentId: e.target.value.toUpperCase()})} /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">系級</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.department} onChange={(e) => setPurchaseData({...purchaseData, department: e.target.value})} /></div>
                                </div>
                            )}
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">匯款後五碼</label><input type="text" required maxLength={5} className="w-full p-3 border border-gray-300 rounded-lg font-mono text-center tracking-widest outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.last5} onChange={(e) => setPurchaseData({...purchaseData, last5: e.target.value})} /></div>
                            <button type="submit" disabled={loading} className="mt-4 w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg shadow-md hover:bg-slate-900 active:scale-95 transition-all disabled:opacity-50">{loading ? "提交中..." : "我已匯款，送出報名"}</button>
                        </form>
                    </div>
                );
            };

            const TrialPage = () => (
                <div className="p-6 animate-slide-in">
                    <BackButton to="home" />
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 border-l-4 border-slate-800 pl-3">單堂體驗課</h2>
                    <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                        <h3 className="font-bold text-orange-800 flex items-center mb-2"><AlertCircle className="mr-2" /> 匯款資訊</h3>
                        <p className="text-sm text-orange-900 mb-2">費用：<span className="font-bold text-lg">$150 / 堂</span></p>
                        <div className="bg-white p-3 rounded border border-orange-100 flex justify-between items-center cursor-pointer active:bg-gray-50" onClick={() => copyToClipboard('88660930767982')}>
                            <div><span className="text-xs text-gray-500 block">將來銀行 (823)</span><span className="font-mono font-bold text-lg">88660930767982</span></div>
                            <Copy className="text-gray-400" />
                        </div>
                    </div>
                    <form onSubmit={(e) => { e.preventDefault(); submitToGoogleSheet(trialData, 'Trial'); }} className="flex flex-col gap-4">
                        <div className="grid grid-cols-2 gap-3">
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">姓名</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={trialData.name} onChange={(e) => setTrialData({...trialData, name: e.target.value})} /></div>
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">手機</label><input type="tel" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={trialData.phone} onChange={(e) => setTrialData({...trialData, phone: e.target.value})} /></div>
                        </div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">匯款後五碼</label><input type="text" required maxLength={5} className="w-full p-3 border border-gray-300 rounded-lg font-mono text-center tracking-widest outline-none focus:ring-2 focus:ring-slate-500" value={trialData.last5} onChange={(e) => setTrialData({...trialData, last5: e.target.value})} /></div>
                        <button type="submit" disabled={loading} className="mt-4 w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg shadow-md hover:bg-slate-900 active:scale-95 transition-all disabled:opacity-50">{loading ? "提交中..." : "送出體驗登記"}</button>
                    </form>
                </div>
            );

            const SuccessPage = () => (
                <div className="flex flex-col items-center justify-center h-full p-8 animate-scale-in text-center">
                    <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6"><Check size={48} className="text-green-600" /></div>
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">操作成功！</h2>
                    <p className="text-gray-500 mb-8">資料已傳送至後台</p>
                    <div className="bg-gray-50 p-4 rounded-lg w-full mb-8 border border-gray-200">
                        <p className="text-sm text-gray-500 mb-1">完成時間</p>
                        <p className="font-mono text-xl font-bold text-gray-700">{new Date().toLocaleString('zh-TW', { hour12: false })}</p>
                    </div>
                    <button onClick={() => { setPage('home'); setMemberData({studentId: '', phone: '', name: '', date: new Date().toISOString().split('T')[0]}); setPurchaseData({name: '', studentId: '', department: '', phone: '', last5: ''}); setTrialData({name: '', phone: '', last5: '', date: new Date().toISOString().split('T')[0]}); }} className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all">返回首頁</button>
                </div>
            );

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        }
    </script>
</body>
</html>
